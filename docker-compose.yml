services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: password-manager-backend
    ports:
      - "19080:19080"
    volumes:
      - ./vaults:/root/vaults
    environment:
      - SERVER_PORT=19080
      - SERVER_ADDR=0.0.0.0
      - VAULT_DIR=/root/vaults
      - ENABLE_TLS=false  # Set to true for HTTPS (requires valid certs or will use self-signed)
      - WEB_DIR=/root/web
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:19080/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  telegram-bot:
    build:
      context: .
      dockerfile: Dockerfile.telegram
    container_name: password-manager-telegram-bot
    env_file:
      - .env
    volumes:
      - ./vaults:/root/vaults
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - VAULT_DIR=/root/vaults
      - SESSION_TTL=${SESSION_TTL:-5m}
      - EPHEMERAL_MESSAGE_TTL=${EPHEMERAL_MESSAGE_TTL:-60s}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-10}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-1m}
      - PASSWORD_RETRIEVAL_MAX=${PASSWORD_RETRIEVAL_MAX:-5}
      - PASSWORD_RETRIEVAL_WINDOW=${PASSWORD_RETRIEVAL_WINDOW:-1m}
      - ALLOWED_USER_IDS=${ALLOWED_USER_IDS:-}
    restart: always
    depends_on:
      backend:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: password-manager-frontend
    ports:
      - "13000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:19080
    restart: always
    depends_on:
      backend:
        condition: service_healthy
